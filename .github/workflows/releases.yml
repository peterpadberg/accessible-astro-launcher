name: Generate Changelog

on:
  push:
    branches:
      - "main"

permissions:
  contents: write

jobs:
  changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Create Draft Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete any existing draft releases first
          DRAFT_TAGS=$(gh release list --limit 100 --json isDraft,tagName | jq -r '.[] | select(.isDraft == true) | .tagName')
          for tag in $DRAFT_TAGS; do
            echo "Deleting existing draft: $tag"
            gh release delete "$tag" --yes --cleanup-tag
          done
          
          # Get the last published release tag
          LAST_TAG=$(gh release list --limit 1 --exclude-drafts --json tagName 2>/dev/null | jq -r '.[0].tagName // empty')
          
          echo "Creating new draft release"
          
          if [ -n "$LAST_TAG" ] && [ "$LAST_TAG" != "null" ]; then
            echo "Generating changelog since last release: $LAST_TAG"
            gh release create "draft" \
              --draft \
              --title "Next Release" \
              --generate-notes \
              --notes-start-tag "$LAST_TAG"
          else
            echo "No previous release found, generating full changelog"
            gh release create "draft" \
              --draft \
              --title "Next Release" \
              --generate-notes
          fi
