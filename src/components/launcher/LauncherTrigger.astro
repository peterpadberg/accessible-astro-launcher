---
/**
 * LauncherTrigger Component
 *
 * @description A trigger button that opens the Launcher dialog, with keyboard shortcut hint.
 * Multiple triggers can target the same launcher using the launcherId prop.
 */

interface Props {
  /**
   * ID of the Launcher dialog this trigger opens (must match Launcher's id prop)
   */
  launcherId: string
  /**
   * Optional unique identifier for this specific trigger element
   */
  id?: string
  /**
   * Placeholder text shown in the trigger
   * @default "Search"
   */
  placeholder?: string
  /**
   * The keyboard shortcut key to display (without modifier)
   * @default "K"
   */
  shortcutKey?: string
  /**
   * Whether to show the compact version of the trigger
   * @default false
   */
  compact?: boolean
  /**
   * Whether to show the icon only version of the trigger
   * @default false
   */
  iconOnly?: boolean
  /**
   * Whether to show a gradient border on the trigger
   * @default false
   */
  gradientBorder?: boolean
  /**
   * Additional classes to apply
   */
  class?: string
  /**
   * HTML attributes to spread on the trigger
   */
  [key: string]: string | boolean | undefined
}

const {
  launcherId,
  id,
  placeholder = 'Search',
  shortcutKey = 'K',
  compact = false,
  iconOnly = false,
  gradientBorder = false,
  class: className,
  ...rest
} = Astro.props
---

<div class:list={['launcher-trigger', gradientBorder && 'gradient-border', className]}>
  <button
    type="button"
    class="trigger"
    id={id}
    class:list={[compact && 'compact', iconOnly && 'icon-only']}
    aria-haspopup="dialog"
    data-launcher-target={launcherId}
    aria-label={placeholder}
    {...rest}
  >
    <span class="wrapper">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
      </svg>
      {compact || iconOnly ? null : <span class="placeholder">{placeholder}</span>}
    </span>
    {
      !iconOnly ? (
        <span class="shortcut">
          <kbd class="key modifier" />
          <kbd class="key">{shortcutKey}</kbd>
        </span>
      ) : null
    }
  </button>
</div>

<script>
  /**
   * Detect the operating system for keyboard shortcut display
   */
  const detectOS = (): 'mac' | 'windows' | 'other' => {
    const userAgent = navigator.userAgent.toLowerCase()

    if (userAgent.includes('mac')) return 'mac'
    if (userAgent.includes('win')) return 'windows'

    return 'other'
  }

  /**
   * Set the OS-specific modifier key icon for all triggers
   */
  const setModifierKeys = () => {
    const os = detectOS()
    const modifierElements = document.querySelectorAll<HTMLElement>('.launcher-trigger .modifier')

    modifierElements.forEach((modifierElement) => {
      if (os === 'mac') {
        // Command key (âŒ˜)
        modifierElement.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M15 6v12a3 3 0 1 0 3-3H6a3 3 0 1 0 3 3V6a3 3 0 1 0-3 3h12a3 3 0 1 0-3-3"/></svg>
          <span class="sr-only">Command</span>
          `
      } else {
        // Ctrl key
        modifierElement.textContent = 'Ctrl'
      }
    })
  }

  // Initialize on load
  setModifierKeys()

  // Re-initialize after Astro view transitions
  document.addEventListener('astro:after-swap', setModifierKeys)
</script>

<style>
  :where(.launcher-trigger) {
    container-type: inline-size;
    min-inline-size: var(--launcher-trigger-width-min);
    min-block-size: var(--launcher-trigger-height);
  }

  :where(.launcher-trigger:has(.compact)) {
    inline-size: var(--launcher-trigger-compact-width);
  }

  :where(.launcher-trigger:has(.icon-only)) {
    inline-size: var(--launcher-trigger-icon-only-size);
    block-size: var(--launcher-trigger-icon-only-size);
  }

  :where(.trigger) {
    display: flex;
    position: relative;
    justify-content: space-between;
    align-items: center;
    transition: border-color var(--launcher-animation-duration) var(--launcher-animation-timing);
    cursor: pointer;
    border: 1px solid var(--launcher-inner-border-color);
    border-radius: var(--launcher-radius-md);
    background-color: var(--launcher-action-bar-color);
    padding: var(--launcher-space-sm);
    inline-size: clamp(var(--launcher-trigger-width-min), 100%, var(--launcher-trigger-width-max));
    min-block-size: var(--launcher-trigger-height);
    color: var(--launcher-text-color);
    font-size: var(--launcher-font-size-md);
    white-space: nowrap;
  }

  :where(.trigger:hover),
  :where(.trigger:focus-visible) {
    border-color: var(--launcher-border-interaction-color);
  }

  :where(.trigger.compact) {
    inline-size: var(--launcher-trigger-compact-width);
  }

  :where(.trigger.icon-only) {
    justify-content: center;
    block-size: var(--launcher-trigger-icon-only-size);
  }

  :where(.wrapper) {
    display: flex;
    flex-shrink: 0;
    align-items: center;
    gap: var(--launcher-space-sm);
  }

  :where(svg) {
    flex-shrink: 0;
  }

  :where(.shortcut) {
    display: flex;
    flex-shrink: 0;
    align-items: center;
  }

  :where(.key) {
    inline-size: fit-content;
    block-size: 20px;
  }

  :where(.key:first-child) {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
    padding-inline-end: 1px;
  }

  :where(.key:last-child) {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    padding-inline-start: 1px;
    font-size: var(--launcher-font-size-sm);
  }

  :where(.launcher-trigger.gradient-border .trigger) {
    --border-width: 2px;

    border: none;
    background: linear-gradient(115deg, #a767e5, #12bcfe, #44ce7b, #fad648, #a767e5);
    background-position: 0 0;
    background-size: 200% 100%;
  }

  .launcher-trigger.gradient-border .trigger::before {
    position: absolute;
    z-index: 1;
    inset: var(--border-width);
    border-radius: calc(var(--launcher-radius-md) - var(--border-width));
    background-color: var(--launcher-action-bar-color);
    content: '';
  }

  :where(.launcher-trigger.gradient-border .trigger > *) {
    position: relative;
    z-index: 2;
  }

  :where(.launcher-trigger.gradient-border .trigger:hover),
  :where(.launcher-trigger.gradient-border .trigger:focus-visible) {
    animation: rainbow-effect 1s linear infinite;
  }

  @keyframes rainbow-effect {
    to {
      background-position: 200% 0;
    }
  }

  @container (max-width: 250px) {
    :where(.launcher-trigger .trigger:not(.compact):not(.icon-only)) {
      inline-size: var(--launcher-trigger-compact-width);
      block-size: var(--launcher-trigger-compact-height);
    }

    :where(.launcher-trigger .trigger:not(.compact):not(.icon-only) .placeholder) {
      display: none;
    }
  }

  @container (max-width: 150px) {
    :where(.launcher-trigger .trigger:not(.compact):not(.icon-only)) {
      justify-content: center;
      inline-size: var(--launcher-trigger-icon-only-size);
    }

    :where(.launcher-trigger .trigger:not(.compact):not(.icon-only) .placeholder),
    :where(.launcher-trigger .trigger:not(.compact):not(.icon-only) .shortcut) {
      display: none;
    }
  }
</style>
